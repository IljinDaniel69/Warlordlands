<h2>Commands Management</h2>
<p>View and manage all game commands submitted by players.</p>

<div class="table-responsive">
    <table class="table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Player</th>
                <th>Army</th>
                <th>Turn</th>
                <th>Command Type</th>
                <th>Status</th>
                <th>Created</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <% if (commands && commands.length > 0) { %>
                <% commands.forEach(function(command) { %>
                    <tr>
                        <td><%= command.id %></td>
                        <td><%= command.player_nick || 'Unknown' %></td>
                        <td><%= command.army_name || 'Unknown' %></td>
                        <td><%= command.turn_display || 'Unknown' %></td>
                        <td>
                            <span class="badge bg-primary"><%= command.command_type %></span>
                        </td>
                        <td>
                            <% if (command.status === 'pending') { %>
                                <span class="badge bg-warning">Pending</span>
                            <% } else if (command.status === 'processing') { %>
                                <span class="badge bg-info">Processing</span>
                            <% } else if (command.status === 'completed') { %>
                                <span class="badge bg-success">Completed</span>
                            <% } else if (command.status === 'failed') { %>
                                <span class="badge bg-danger">Failed</span>
                            <% } else { %>
                                <span class="badge bg-secondary"><%= command.status %></span>
                            <% } %>
                        </td>
                        <td><%= new Date(command.created_at).toLocaleString() %></td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="viewCommandDetails('<%= command.id %>')">
                                View Details
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="editCommandStatus('<%= command.id %>', '<%= command.status %>')">
                                Edit Status
                            </button>
                        </td>
                    </tr>
                <% }); %>
            <% } else { %>
                <tr>
                    <td colspan="8" class="text-center">No commands found</td>
                </tr>
            <% } %>
        </tbody>
    </table>
</div>

<!-- Command Details Modal -->
<div class="modal fade" id="commandDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Command Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="commandDetailsContent">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Status Modal -->
<div class="modal fade" id="editStatusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Command Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editStatusForm">
                    <input type="hidden" id="editCommandId">
                    <div class="form-group">
                        <label for="editStatus">Status:</label>
                        <select class="form-control" id="editStatus" required>
                            <option value="pending">Pending</option>
                            <option value="processing">Processing</option>
                            <option value="completed">Completed</option>
                            <option value="failed">Failed</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editResult">Result (JSON):</label>
                        <textarea class="form-control" id="editResult" rows="3" placeholder='{"message": "Command executed successfully"}'></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveCommandStatus()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<script>
function viewCommandDetails(commandId) {
    // Find the command data from the table
    const commandRow = document.querySelector(`tr:has(td:first-child:contains('${commandId}'))`);
    if (!commandRow) return;
    
    const cells = commandRow.querySelectorAll('td');
    const commandData = {
        id: cells[0].textContent,
        player: cells[1].textContent,
        army: cells[2].textContent,
        turn: cells[3].textContent,
        type: cells[4].querySelector('.badge').textContent,
        status: cells[5].querySelector('.badge').textContent,
        created: cells[6].textContent
    };
    
    // Get the command object from the server data
    const commands = JSON.parse('<%- JSON.stringify(commands) %>');
    const command = commands.find(c => c.id == commandId);
    
    if (command) {
        let content = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Basic Information</h6>
                    <table class="table table-sm">
                        <tr><td><strong>ID:</strong></td><td>${command.id}</td></tr>
                        <tr><td><strong>Player:</strong></td><td>${command.player_nick || 'Unknown'}</td></tr>
                        <tr><td><strong>Army:</strong></td><td>${command.army_name || 'Unknown'}</td></tr>
                        <tr><td><strong>Turn:</strong></td><td>${command.turn_display || 'Unknown'}</td></tr>
                        <tr><td><strong>Type:</strong></td><td>${command.command_type}</td></tr>
                        <tr><td><strong>Status:</strong></td><td>${command.status}</td></tr>
                        <tr><td><strong>Created:</strong></td><td>${new Date(command.created_at).toLocaleString()}</td></tr>
                        <tr><td><strong>Updated:</strong></td><td>${new Date(command.updated_at).toLocaleString()}</td></tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h6>Command Data</h6>
                    <pre class="bg-light p-2 rounded">${JSON.stringify(JSON.parse(command.command_data || '{}'), null, 2)}</pre>
                </div>
            </div>
        `;
        
        if (command.result) {
            content += `
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>Result</h6>
                        <pre class="bg-light p-2 rounded">${JSON.stringify(JSON.parse(command.result), null, 2)}</pre>
                    </div>
                </div>
            `;
        }
        
        document.getElementById('commandDetailsContent').innerHTML = content;
        new bootstrap.Modal(document.getElementById('commandDetailsModal')).show();
    }
}

function editCommandStatus(commandId, currentStatus) {
    document.getElementById('editCommandId').value = commandId;
    document.getElementById('editStatus').value = currentStatus;
    document.getElementById('editResult').value = '';
    
    new bootstrap.Modal(document.getElementById('editStatusModal')).show();
}

function saveCommandStatus() {
    const commandId = document.getElementById('editCommandId').value;
    const status = document.getElementById('editStatus').value;
    const result = document.getElementById('editResult').value;
    
    // Send update request
    fetch(`/admin/commands/update/${commandId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            status: status,
            result: result || null
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error updating command: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating command');
    });
}
</script>
